/*!
 * jQuery Network-Graph
 * - Depends on RaphaelJS to draw the canvas lines
 * - Depends on JQueryUI for dragging and Easing animations
 * 
 * Templates - any JSON fields you want to show need
 * to be wrapped in [%%] in the template, as below
 *     '<h2>[%title%]</h2>'
 *
 *
 * This way you can add any fields you wish to the JSON.
 * The only _required_ fields are the .uid for the child nodes - for now at least
 *
 * JSON for nodes looks something like
 *    {
 *        "title" : "Node title",
 *        "lineColour" : "#fff",
 *        "text" : "Descriptive text",
 *        "children" : [{
 *                        "id" : "child-node-id",
 *                        "title" : "Child node title",
 *                        "lineColour" : "#ff0",
 *                        "type" : "theme"
 *                    }]
 *   }
 *
 * Original author: @large-blue
 * Licensed under the MIT license
 *
 */
(function(e,c,a,g){var d="lbNetworkGraph",f={templates:{"default":'<div class="network-node"><h2>[%title%]</h2><p>[%text%]</p></div>',theme:'<div class="network-node theme"><h2>[%title%]</h2></div>'},initialNodeID:"1",jsonURL:"./json/[%id%].json",nodeId:"collab-node-id-",draggable:true,distanceNodes:100,distanceIncrement:4,moveTime:1000,angleLimit:180,className:{node:"lb-network-node",nodeHover:"lb-node-hover",trailing:"lb-trailing-node"}};function b(i,h){this.element=i;this.$el=e(i);this.options=e.extend({},f,h);this._defaults=f;this._name=d;this.init()}b.prototype={raphael:c.Raphael,init:function(){this.$el.css({overflow:"hidden"});this.map=e('<div class="collab-map" />').appendTo(this.$el).css({height:"9999px",position:"absolute",width:"9999px"});var i="raphael-rnd-num-"+(Math.floor(Math.random()*10000000));this.lines=e('<div id="'+i+'" class="collab-lines" />').appendTo(this.map).css({height:"100%",top:"0",left:"0",position:"absolute",width:"100%"});this.initiateCanvas(i);this.nodes=e('<div class="collab-node-parent" />').appendTo(this.map).css({height:"100%",top:"0",left:"0",position:"absolute",width:"100%"});this.zoomIn=e('<div class="collab-map-zoom-in">+</div>').appendTo(this.$el).click((function(k){return function(){k.zoom("in")}})(this));this.zoomOut=e('<div class="collab-map-zoom-out">-</div>').appendTo(this.$el).click((function(k){return function(){k.zoom("out")}})(this));var h=this._centerPos();var j=this._centerScreen();this.map.css({left:-h[0]+"px",top:-h[1]+"px"});if(this.options.draggable&&typeof(c.$.ui)!="undefined"&&typeof(c.$.ui.draggable)!="undefined"){this.map.draggable();this.nodes.addClass("grab-cursor");this.nodes.mousedown(function(){e(this).addClass("grabbing-cursor")});this.nodes.mouseup(function(){e(this).removeClass("grabbing-cursor")})}this.map.on("click","."+this.options.className.node,(function(k){return function(m){m.stopPropagation();var l=e(this);if(l.hasClass("collab-selected")&&l.data("parent")){k.selectNode(l.data("parent"));k.centerToNode(l.data("parent"))}else{k.selectNode(l);k.centerToNode(l)}}})(this));this.map.on("mouseover","."+this.options.className.node,(function(k){return function(l){l.stopPropagation();k.nodes.find("."+k.options.className.nodeHover).removeClass(k.options.className.nodeHover);e(this).addClass(k.options.className.nodeHover)}})(this));this._addInitialNode()},initiateCanvas:function(h){if(this.raphael){this.paper=Raphael(h,this.map.height(),this.map.width())}},centerToNode:function(j){var m=j.data("coords");if(j.data("parent")){var o=j.data("parent").offset();m.left+=o.left;m.top+=o.top}else{m=j.offset()}var n=this.map.offset();var h=n.left-m.left;var l=n.top-m.top;h=this.$el.outerWidth()/2+h-(j.outerWidth()/2);l=this.$el.outerHeight()/2+l-(j.outerHeight()/2);var r=Math.abs(h-this.map.position().left);var q=Math.abs(l-this.map.position().top);var k=q/(Math.sin(Math.atan(q/r)));var i=Math.floor((k/260)*600);var p=e.easing.easeInOutQuint?"easeInOutQuint":"linear";this.map.stop(true,true).animate({left:h,top:l},i,p)},selectNode:function(h){var k=this.nodes.find(".collab-selected").removeClass("collab-selected");this.deSelectNode(k);this._deTrailNode(k);h.addClass("collab-selected");if(h.data("line")){h.data("line").attr({"stroke-width":3})}this._trailNode(h);j=h.data("parent");while(j){this._trailNode(j);j=j.data("parent")}var j=k.data("parent");while(j){this._deTrailNode(j);j=j.data("parent")}this._distFromParent(h,(this.options.distanceNodes*this.options.distanceIncrement));var i=this;setTimeout(function(){i._getChildren(h)},this.options.moveTime);this.nodes.find(".lb-network-new-trail").removeClass("lb-network-new-trail")},deSelectNode:function(h){h.removeClass("collab-selected")},_trailNode:function(h){h.addClass(this.options.className.trailing+" lb-network-new-trail");if(h.data("line")){h.data("line").attr({"stroke-width":3})}},_deTrailNode:function(h){if(!h.hasClass("lb-network-new-trail")){h.removeClass(this.options.className.trailing);if(h.data("line")){h.data("line").attr({"stroke-width":6})}var i=this;setTimeout(function(){i._removeChildren(h)},10)}else{h.removeClass("lb-network-new-trail")}},_addInitialNode:function(){var i=this;var h=this.options.jsonURL.replace(/\[\%id\%\]/gi,this.options.initialNodeID);e.ajax({url:h,dataType:"json",error:function(j){},success:(function(j){return function(o){var n="default";if(o.type&&this.options.templates[o.type]){n=o.type}var l=e(j._replace(j.options.templates[n],o)).appendTo(j.nodes).attr({id:j.options.nodeId+j.options.initialNodeID}).addClass(j.options.className.node);var k=j._centerScreen();var m=j._centerPos();l.addClass(j.options.className.trailing).css({left:k[0]+"px",top:k[1]+"px"}).data({coords:{left:m[0],top:m[1]},children:o.children||[]});j._getChildren(l)}})(this)})},_removeChildren:function(h){if(!h.hasClass(this.options.className.trailing)){this._distFromParent(h,this.options.distanceNodes);var i=h.find("."+this.options.className.node);i.each(function(){e(this).data("line").remove()});h.find(".children-nodes").animate({opacity:0},500,function(){e(this).remove()})}},_replace:function(m,l){var n=new RegExp("\\[.*?\\]");var i=m.match(n);var h=10;while(i&&h--){var k=i[0].replace(/\[/,"").replace(/\%/g,"").replace(/\]/,"");k=l[k]||"";m=m.replace(i,k);i=m.match(n)}return m},_getChildren:function(h){if(!h.data("children")){var i=this.options.jsonURL.replace(/\[\%id\%\]/gi,h.data("id"));e.ajax({url:i,dataType:"json",error:function(j){},success:(function(j){return function(k){h.data({children:k.children});j._setChildren(h)}})(this)})}else{this._setChildren(h)}},_setChildren:function(l){var h=l.data("children");var q=h.length;var r=e('<div class="children-nodes" />').appendTo(l).css({position:"absolute",left:"50%",top:"50%"});var i=this.paper;var n=l.position();var j=this.options.nodeId;var k=Math.floor(Math.random()*360);if(l.data("parent")){q++}var o=l.data("parent")?this.options.angleLimit:360;var s=o/q;if(l.data("parent")){k=l.data("angleFromParent")+s-(this.options.angleLimit/2)}var p=this.options.templates;var m=this;e.each(h,function(u){if(!e("#"+j+h[u].uid).length){var x="default";if(h[u].type&&p[h[u].type]){x=h[u].type}var y=p[x];var t=e(m._replace(y,h[u])).appendTo(r).addClass(m.options.className.node);t.attr({id:j+h[u].uid}).css({left:0,top:0});var v=l;n=l.position();while(v.data("parent")){v=v.data("parent");var z=v.position();n.left+=z.left;n.top+=z.top}var w="M"+n.left+" "+n.top+"L"+n.left+" "+n.top;t.data({parent:l,angleFromParent:k,lineColour:h[u].lineColour||"#fff",id:h[u].uid});if(m.raphael){t.data({line:m.paper.path(w)});t.data("line").attr({"stroke-width":6,stroke:t.data("lineColour")})}m._distFromParent(t);k+=s}})},_distFromParent:function(h,q){if(h.data("parent")){if(typeof(q)=="undefined"){q=this.options.distanceNodes}var r=Math.PI/180;var u=childY=0;var k=h.data("angleFromParent");var p=h.outerWidth()/2;var s=h.outerHeight()/2;var j=h.data("parent").outerWidth()/2;var v=h.data("parent").outerHeight()/2;var m=0;var t=Math.atan(p/s);t=Math.round(t*180/Math.PI);var n=Math.atan(j/v);n=Math.round(n*180/Math.PI);var i=k;if(i>360){i=i%360}else{if(i<0){i=360+i}}if(i>270){i=360-i}else{if(i>180){i=i-180}else{if(i>90){i=180-i}}}if(i<t){m=s/Math.cos(i*r)}else{m=p/Math.sin(i*r)}if(i<n){m+=v/Math.cos(i*r)}else{m+=j/Math.sin(i*r)}var l=q+m;u=parseInt(l*Math.sin(k*r));childY=parseInt(l*Math.cos(k*r));var o=e.easing.easeOutElastic?"easeOutElastic":"linear";h.data({coords:{left:u,top:childY}}).animate({left:u+"px",top:childY+"px"},this.options.moveTime,o);this._drawLineToParent(h)}},_drawLineToParent:function(h){if(h.data("parent")){var j=h.data("parent");var l=j.position();while(j.data("parent")){j=j.data("parent");var m=j.position();l.left+=m.left;l.top+=m.top}var k="M"+l.left+" "+l.top+"L"+(l.left+h.data("coords").left)+" "+(l.top+h.data("coords").top);var i=e.easing.easeOutElastic?"elastic":"linear";if(this.raphael){h.data("line").animate({path:k},this.options.moveTime,i)}}},zoom:function(j){var i=parseFloat(this.$el.css("font-size"));var h=2/3;if(typeof(j)!="undefined"&&j=="in"){h=1.5}this.$el.css({fontSize:i*h+"px"})},_centerPos:function(){var h=(this.map.height()/2);var i=(this.map.width()/2);return[i,h]},_centerScreen:function(){var i=(this.map.height()/2)+(this.$el.height()/2);var h=(this.map.width()/2)+(this.$el.width()/2);return[h,i]}};e.fn[d]=function(h){return this.each(function(){if(!e.data(this,"plugin_"+d)){e.data(this,"plugin_"+d,new b(this,h))}})}})(jQuery,window,document);