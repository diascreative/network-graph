<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Network Graph</title>
        <link rel="stylesheet" href="./css/style.css" type="text/css" />
        <link rel="stylesheet" href="./css/lb-collab.css" type="text/css" />
    </head>
    <body>
        <div id="network"></div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript">
            !window.jQuery && document.write('<script src="./js/jquery-1.7.2.min.js"><\/script>');
        </script>

        <!-- this custom query-ui only contains the draggable and easing functions -->
        <script src="./js/jquery-ui-1.8.18/jquery-ui-1.8.18.custom.min.js"></script>

        <!-- great little plugin for touch devices ( to allow jquery ui dragging in them -->
        <script src="./js/jquery.ui.touch-punch.min.js"></script>
        
        <script src="./js/jquery.transit.min.js"></script>
        
        <!-- we rely on RaphaelJS to draw the lines between nodes -->
        <script src="./js/raphael-min.js"></script>

        <!-- Plugin -->
        <script src="./js/jquery.network-graph.0.1.js"></script>

        <script type="text/javascript">
            $('#network').lbNetworkGraph({
                initialNodeID : 'centralNode',
                jsonURL         : './json-data/[%id%].json',
                distanceNodes : 150,
                returnToParent : false,
                distanceIncrement : 1,
                angleLimit : 200,
                lineWidth : 3,
                templates : {
                    'default' : '<div class="network-node clearfix">' +
                                    '<img class="thumbnail" src="http://filmstore.bfi.org.uk/acatalog/[%image%]" />' +
                                    '<div class="text"><h4>[%title%]</h4><p>[%description%]</p></div>' +
                                    '<div class="actions">' + 
                                        '<button class="change-relations set-decade" rel="decades/1980">80s</button>' +
                                        '<button class="change-relations set-director" rel="directors/glassman-arnold">Glassman, Arnold</button>' +
                                        '<button class="change-relations set-genre" rel="genres/early-and-silent-cinema">Early and Silent Cinema</button></div>' +
                                        '<button class="return-parent">Back</button></div>' +
                                 '</div>',
                    'centralNode' : '<div class="starting-node">' +
                                        '<div>[%text%]</div>' +
                                     '</div>',
                    'directors' : '<div class="selection-box directors-box">' +
                                        '<div>[%text%]</div>' +
                                     '</div>',
                    'decades' : '<div class="selection-box decades-box">' +
                                        '<div>[%text%]</div>' +
                                     '</div>',
                    'decade' : '<div class="group-node decade-box">' +
                                        '<div class="decade-name">[%title%]</div>' +
                                     '</div>',
                    'director' : '<div class="group-node director-box">' +
                                        '<div class="director-name">[%title%]</div>' +
                                     '</div>',
                    'genres' : '<div class="selection-box genres-box">' +
                                        '<div>[%text%]</div>' +
                                     '</div>',
                    'genre' : '<div class="group-node genre-box">' +
                                        '<div class="genre-name">[%title%]</div>' +
                                     '</div>',
                }
            });

            $('#network').on('mousedown', 'area', function(e) {
                e.stopPropagation();

                var option = $(this).attr('href').replace('#', '');
                var $wheel = $('.wheel-background');
                
                var angles = {
                    genre    : 60,
                    director : 180,
                    decade   : 300
                }

                var angle = parseInt($wheel.css('rotate'));

                var dAngle = angles[option] - angle;
                var vAngle = Math.abs(dAngle);

                if( dAngle > 239 ) {
                    angle = '-=' + (360-vAngle);
                } else if( dAngle > -121 && dAngle < 0 ) {
                    angle = '+=' + (-vAngle);
                } else if( dAngle > -241 && dAngle < -120 ) {
                    angle = '+=' + (360-vAngle);
                } else if( dAngle < 0 )
                    angle = '-=' + vAngle;
                else
                    angle = '+=' + vAngle;

                $wheel.transition({ rotate : angle + 'deg' }, function() {
                    var angle = parseInt($wheel.css('rotate'));

                    if( angle > 360 )
                        $wheel.css({ rotate : (angle%360) + 'deg' });
                    else if( angle < 0 ) {
                        $wheel.css({ rotate : (360+angle) + 'deg' });
                    }
                });

                var map = $('#network').data('lbNetworkGraph');

                map.dragged = true;

                if( option == 'director' )
                    map.options.lineColour = '#ED1C24';
                else if( option == 'decade' )
                    map.options.lineColour = '#8DC63F';
                else
                    map.options.lineColour = '#27AAE1';

                var startNode = map.getStartNode();
                var nodeName = '.' + option + 's-box, .' + option + '-box';

                if( startNode.hasClass('collab-selected') || !$(nodeName).length ) {
                    startNode.data('id',option);
                    startNode.removeData('children');

                    map.setStartAngle(120);

                    map.removeChildren(startNode);
    
                    map.onChildrenSet = function() {
                        map.setStartAngle(false);
                        var childNode = startNode.find('.' + option + 's-box').closest('.lb-network-node').last();

                        map.selectNode(childNode);
                        map.centerToNode(childNode);

                        map.onChildrenSet = function() { };
                    }

                    map.getChildren(startNode);
                } else {
                    map.removeChildren(startNode);
                    map.centerToNode(startNode);
                }
            });

            $('#network').on('mousedown', 'button.return-parent', function(e) {
                e.preventDefault();

                var map = $('#network').data('lbNetworkGraph');
                var currentNode = map.currentNode();
                
                map.selectNode(currentNode.data('parent'));
                map.centerToNode(currentNode.data('parent'));
                
            });
            
            $('#network').on('mouseenter', '.thumbnail', function() {
                $('#network').data('lbNetworkGraph').dragged = false;
            });
            
            $('#network').on('mousedown', '.thumbnail', function() {
                var $node = $(this).closest('.lb-network-node');
                var isSel = $(this).parent().parent().hasClass('collab-selected');
                var isTrail = $(this).parent().parent().hasClass('lb-trailing-node');
                
                if( !isSel && isTrail ) {
                    var map = $('#network').data('lbNetworkGraph');
                    map.removeChildren($node);
                }
            });

            $('#network').on('mousedown', 'button.change-relations', function(e) {
                var map = $('#network').data('lbNetworkGraph');
                var $button = $(this);
                var choice = $button.attr('rel');
                var currentNode = map.currentNode();

                currentNode.removeData('children');

                map.removeChildren(currentNode);

                if( $button.hasClass('set-decade') )
                    map.options.lineColour = '#8DC63F';
                else if( $button.hasClass('set-director') )
                    map.options.lineColour = '#ED1C24';
                else
                    map.options.lineColour = '#27AAE1';

                $.ajax({
                    url : './json-data/' + choice + '.json',
                    success : function(res) {
                        var children = res.children;
                        delete res.children;

                        currentNode.data('children', [res])
                                   .removeClass('collab-selected');

                        map.onChildrenSet = function() {
                            map.onChildrenSet = function() { };

                            var childNode = currentNode.find('.children-nodes .lb-network-node').last();
                            childNode.data('children', children);

                            var childPar = childNode.parent();
                            childPar.removeClass('node-for-decade node-for-director node-for-genre');
                            childPar.addClass('node-for-' + childNode.data('type'));

                            map.onCenterNode = function() {
                                map.onCenterNode = function() {};

                                setTimeout(function() { map.getChildren(childNode) }, 1000);
                            }

                            map.selectNode(childNode);
                            map.centerToNode(childNode);
                        }

                        map.getChildren(currentNode);
                    }
                });
            });

            $('#network').on('mouseup', 'area', function(e) {
                var map = $('#network').data('lbNetworkGraph');
                setTimeout(function() { map.dragged = false; }, 10);
            });

            
            $('#network').on('mouseenter', '.group-node', function() {
                var map = $('#network').data('lbNetworkGraph');
                map.options.showChildren = true;
            }).on('mouseleave', '.group-node', function() {
                var map = $('#network').data('lbNetworkGraph');
                map.options.showChildren = false;
            });

            $('#network').on('change', '.selection-box select', function() {
                var map = $('#network').data('lbNetworkGraph');
                var $select = $(this);
                var startNode = map.getStartNode();
                
                var $node = $select.closest('.lb-network-node');
                $node.data('line').remove();

                startNode.removeData('children');

                map.removeChildren(startNode);

                $.ajax({
                    url : './json-data/' + $select.val() + '.json',
                    success : function(res) {
                        var children = res.children;
                        delete res.children;

                        startNode.data('children', [res]);
                        map.setStartAngle(80 + Math.floor(Math.random()*80));

                        map.onChildrenSet = function() {
                            map.onChildrenSet = function() { };
                            map.setStartAngle(false);

                            var childNode = startNode.find('.children-nodes .lb-network-node').last();
                            childNode.data('children', children);

                            var childPar = childNode.parent();
                            childPar.removeClass('node-for-decade node-for-director node-for-genre');
                            childPar.addClass('node-for-' + childNode.data('type'));

                            map.onCenterNode = function() {
                                map.onCenterNode = function() {};

                                setTimeout(function() { map.getChildren(childNode) }, 1000);
                            }

                            map.selectNode(childNode);
                            map.centerToNode(childNode);
                        }

                        map.getChildren(startNode);
                    }
                });
            });
        </script>
    </body>
</html>