<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Network Graph</title>
        <link rel="stylesheet" href="./css/style.css" type="text/css" />
        <link rel="stylesheet" href="./css/lb-collab.css" type="text/css" />
    </head>
    <body>
        <div id="network"></div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript">
            !window.jQuery && document.write('<script src="./js/jquery-1.7.2.min.js"><\/script>');
        </script>

        <!-- this custom query-ui only contains the draggable and easing functions -->
        <script src="./js/jquery-ui-1.8.18/jquery-ui-1.8.18.custom.min.js"></script>

        <!-- great little plugin for touch devices ( to allow jquery ui dragging in them -->
        <script src="./js/jquery.ui.touch-punch.min.js"></script>
        
        <script src="./js/jquery.transit.min.js"></script>
        
        <!-- we rely on RaphaelJS to draw the lines between nodes -->
        <script src="./js/raphael-min.js"></script>

        <!-- Plugin -->
        <script src="./js/jquery.network-graph.0.1.js"></script>

        <script type="text/javascript">
            $('#network').lbNetworkGraph({
                initialNodeID : 'centralNode',
                jsonURL         : './json-data/[%id%].json',
                templates : {
                    'default' : '<div class="network-node clearfix">' +
                                    '<img class="thumbnail" src="http://filmstore.bfi.org.uk/acatalog/[%image%]" />' +
                                    '<div class="text"><h4>[%title%]</h4><p>[%description%]</p></div>' +
                                 '</div>',
                    'centralNode' : '<div class="starting-node">' +
                                        '<div>[%text%]</div>' +
                                     '</div>',
                    'directors' : '<div class="selection-box">' +
                                        '<div>[%text%]</div>' +
                                     '</div>',
                    'director' : '<div class="director-box">' +
                                        '<div class="director-name">[%text%]</div>' +
                                     '</div>'
                }
            });

            $('#network').on('mousedown', 'area', function(e) {
                e.stopPropagation();

                var option = $(this).attr('href').replace('#', '');
                var $wheel = $('.wheel-background');
                
                var angles = {
                    genre    : 60,
                    director : 180,
                    decade   : 300
                }

                var angle = parseInt($wheel.css('rotate'));

                var linePos = 60;

                if( angle - angles[option] > 180 )
                    angle = '+=' + (angles[option] + linePos);
                else if( angle - angles[option] < -180 )
                    angle = '-=' + Math.abs(( (360+linePos) - angles[option] ));
                else
                    angle = angles[option];

                $wheel.transition({ rotate : angle + 'deg' }, function() {
                    var angle = parseInt($wheel.css('rotate'));

                    if( angle > 360 )
                        $wheel.css({ rotate : (angle%360) + 'deg' });
                    else if( angle < 0 ) {
                        $wheel.css({ rotate : (360+angle) + 'deg' });
                    }
                });

                var map = $('#network').data('lbNetworkGraph');
    
                var startNode = map.getStartNode();

                if( startNode.hasClass('collab-selected') ) {
                    startNode.data('id',option);
                    startNode.removeData('children');

                    map.setStartAngle(120);
                    map.removeChildren(startNode);
    
                    map.onChildrenSet = function() {
                        map.setStartAngle(false);
                        map.centerToNode(startNode.find('.lb-network-node'));
                        map.selectNode(startNode.find('.lb-network-node'));
                        centerImages();
                        map.onChildrenSet = function() { centerImages(); };
                    }
    
                    map.getChildren(startNode);
                } else {
                    map.removeChildren(startNode);
                }
            });

            $('#network').on('change', '.selection-box select', function() {
                var map = $('#network').data('lbNetworkGraph');
                var $select = $(this);
                var startNode = map.getStartNode();
                
                var $node = $select.closest('.lb-network-node');
                $node.data('line').remove();

                startNode.removeData('children');

                map.removeChildren(startNode);

                $.ajax({
                    url : './json-data/' + $select.val() + '.json',
                    success : function(res) {
                        var children = res.children;
                        delete res.children;

                        startNode.data('children', [res]);
                        map.setStartAngle(60 + Math.floor(Math.random()*120));

                        map.onChildrenSet = function() {
                            centerImages();
                            map.onChildrenSet = function() { centerImages(); };
                            map.setStartAngle(false);

                            var childNode = startNode.find('.children-nodes .lb-network-node').last();
                            childNode.data('children', children);

                            map.onCenterNode = function() {
                                map.onCenterNode = function() {};

                                map.getChildren(childNode);
                            }

                            map.selectNode(childNode);
                            map.centerToNode(childNode);
                        }

                        map.getChildren(startNode);
                    }
                });
            });

            function centerImages() {
            /*
                $('.network-node img.thumbnail:not(.loaded)').load(function() {
                    var $this = $(this);
                    var marginLeft = $this.width()/-2;

                    $this.addClass('loaded').closest('.network-node').css({ marginLeft : marginLeft });
                });
/**/
            }
        </script>
    </body>
</html>