<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Network Graph</title>
        <link rel="stylesheet" href="./css/style.css" type="text/css" />
        <link rel="stylesheet" href="./css/lb-collab.css" type="text/css" />
    </head>
    <body>
    	<h1 id="logo">BFI</h1>
    	<a href="http://largeblue.com" id="large-blue" target="_blank">Prototype by Large Blue</a>
    	<div id="controls">
	    	<a href="#" class="collab-fit">View All</a>
	    	<a href="#" class="collab-fit-back selected">Reset</a>
	    	<span></span>
	    	<a href="#" class="social facebook"><span></span>facebook</a>
	    	<a href="#" class="social twitter"><span></span>twitter</a>
	    	<a href="#" class="social mail"><span></span>Email</a>
	    </div>
        <div id="network" class="concept-2"></div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript">
            !window.jQuery && document.write('<script src="./js/jquery.1.7.1.min.js"><\/script>');
        </script>

        <!-- this custom query-ui only contains the draggable and easing functions -->
        <script src="./js/jquery-ui-1.8.18/jquery-ui-1.8.18.custom.min.js"></script>

        <!-- great little plugin for touch devices ( to allow jquery ui dragging in them -->
        <script src="./js/jquery.ui.touch-punch.min.js"></script>
        
        <script src="./js/jquery.transit.min.js"></script>
        
        <!-- we rely on RaphaelJS to draw the lines between nodes -->
        <script src="./js/raphael-min.js"></script>

        <!-- Plugin -->
        <script src="./js/jquery.network-graph.0.1.js"></script>
        
        
        <script src="./js/jquery.mousewheel.js"></script>        

        <script type="text/javascript">
            $('#network').lbNetworkGraph({
                initialNodeID : 'centralNode',
                jsonURL         : './json-data/[%id%].json',
                distanceNodes : 180,
                defaultImageReplace : './img/bfi-logo.png',
                defaultImageWatch : '.thumbnail',
                returnToParent : false,
                distanceIncrement : 1.5,
                angleLimit : 260,
                lineWidth : 3,
                showChildren : false,
                templates : {
                    'default' : '<div class="network-node clearfix">' +
                                    '<div class="node-info-left-side"><img class="thumbnail" src="http://filmstore.bfi.org.uk/acatalog/[%image%]" /><div class="film-info"></div></div>' +
                                    '<div class="text"><h4>[%title%]</h4><h3></h3><div class="description"><p>[%description%]</p></div></div>' +
                                    '<div class="actions">' + 
                                        '<button class="change-relations set-decade" rel=""></button>' +
                                        '<button class="change-relations set-director" rel=""></button>' +
                                        '<button class="change-relations set-genre" rel=""></button>' +
                                        '<button class="return-parent">Close</button></div>' +
                                 '</div>',
                    'centralNode' : '<div class="starting-node">' +
                                        '<div>[%text%]</div>' +
                                     '</div>',
                    'directors' : '<div class="selection-box directors-box">' +
                                        '<div>[%text%]</div>' +
                                     '</div>',
                    'decades' : '<div class="selection-box decades-box">' +
                                        '<div>[%text%]</div>' +
                                     '</div>',
                    'decade' : '<div class="group-node decade-box">' +
                                        '<div class="text-field decade-name">[%title%]</div>' +
                                     '</div>',
                    'director' : '<div class="group-node director-box">' +
                                        '<div class="text-field director-name">[%title%]</div>' +
                                     '</div>',
                    'genres' : '<div class="selection-box genres-box">' +
                                        '<div>[%text%]</div>' +
                                     '</div>',
                    'genre' : '<div class="group-node genre-box">' +
                                        '<div class="text-field genre-name">[%title%]</div>' +
                                     '</div>'
                }, onSelectNode : function() {
                    var map = $('#network').data('lbNetworkGraph');
                    var currentNode = map.currentNode();
                    
                    var extraInformationTypes = ['default'];
                    var roundNodes = ['genre', 'director', 'decade'];
                    var selectionNodes = ['genres', 'directors', 'decades'];

                    var nodeType = currentNode.data('type');

                    if( ~$.inArray(nodeType, roundNodes) ) {
                        var $field = currentNode.find('.text-field');
                        $field.css({ marginTop : '-' + ($field.outerHeight()/2) + 'px', top : '50%'})
                    }

                    if( ~$.inArray(nodeType, selectionNodes) ) {
                        var $list = currentNode.find('.option-list');
                        var $cont = currentNode.find('.list-container');

                        var $options = $list.find('a');

                        var $search = currentNode.find('input').bind('keyup', function() {
                            var value = $(this).val().toLowerCase();

                            $options.each(function() {
                                var $this = $(this);

                                if( ~$this.text().toLowerCase().indexOf(value) )
                                    $this.show();
                                else
                                    $this.hide();
                            });
                        }).focus();
                    }

                    if( ~$.inArray(nodeType, extraInformationTypes) ) {
                        var url = this.jsonURL.replace(/\[\%id\%\]/gi, currentNode.data('id'));

                        // make sure to remove its kids if we're selecting it, in case we're going back the trail
                        map.removeChildren(currentNode);

                        $.ajax({
                            url : url,
                            dataType : 'json',
                            success : function(res) {
                                var directorBtn = currentNode.find('.set-director');
                                var decadeBtn = currentNode.find('.set-decade');
                                var genreBtn = currentNode.find('.set-genre');

                                // update buttons
                                var decade = res.Year;

                                if( decade.indexOf('-') ) {
                                    decade = decade.split('-')[0];
                                }

                                decade = Math.floor(parseInt(decade)/10) * 10;
                                
                                var decadeS = decade.toString();

                                decadeBtn.text(decadeS.substring(decadeS.length-2) + 's').attr('rel', 'decades/' + decade);
                                directorBtn.text(res.Director).attr('rel', 'directors/' + slugText(res.Director));
                                directorBtn.closest('.lb-node').find('>.text>h3').text(res.Director);
                                genreBtn.text(res.Genre).attr('rel', 'genres/' + slugText(res.Genre));
                                
                                var info = 'Certificate :' + res.Certificate + '<br />' +
                                           'Year : ' + res.Year + '<br />' +
                                           'Colour : '+ res.Colour;
                                
                                currentNode.find('.film-info').html(info);
                            }
                        })
                    }

                }
            });

            function slugText(text) {
                var strip = /[^\w\s-]/g,
                    hyphen = /[-\s]+/g;
                
                text.toLowerCase();
        
                var map = {
                  from: 'àáäãâèéëêìíïîòóöôõùúüûñç·/_,:;',
                  to  : 'aaaaaeeeeiiiiooooouuuunc------'
                };
        
                for ( var i=0, j=map.from.length; i < j; i++ ) {
                    text = text.replace(new RegExp(map.from.charAt(i), 'g'), map.to.charAt(i));
                }
        
                return $.trim(text.replace(strip, '')).toLowerCase().replace(hyphen, '-');
            }

            $('#network').on('mousedown', 'area', function(e) {
                e.stopPropagation();

                var option = $(this).attr('href').replace('#', '');
                var $wheel = $('.wheel-background');
                
                var angles = {
                    genre    : 60,
                    director : 180,
                    decade   : 300
                }

                var angle = parseInt($wheel.css('rotate'));

                var dAngle = angles[option] - angle;
                var vAngle = Math.abs(dAngle);

                if( dAngle > 239 ) {
                    angle = '-=' + (360-vAngle);
                } else if( dAngle > -121 && dAngle < 0 ) {
                    angle = '+=' + (-vAngle);
                } else if( dAngle > -241 && dAngle < -120 ) {
                    angle = '+=' + (360-vAngle);
                } else if( dAngle < 0 )
                    angle = '-=' + vAngle;
                else
                    angle = '+=' + vAngle;

                $wheel.transition({ rotate : angle + 'deg' }, function() {
                    var angle = parseInt($wheel.css('rotate'));

                    if( angle > 360 )
                        $wheel.css({ rotate : (angle%360) + 'deg' });
                    else if( angle < 0 ) {
                        $wheel.css({ rotate : (360+angle) + 'deg' });
                    }
                });

                var map = $('#network').data('lbNetworkGraph');

                map.dragged = true;

                if( option == 'director' )
                    map.options.lineColour = '#ED1C24';
                else if( option == 'decade' )
                    map.options.lineColour = '#8DC63F';
                else
                    map.options.lineColour = '#27AAE1';

                $wheel.removeClass('director-selected decade-selected genre-selected').addClass(option + '-selected');

                var startNode = map.getStartNode();
                var nodeName = '.' + option + 's-box, .' + option + '-box';

                if( startNode.hasClass('collab-selected') || !$(nodeName).length ) {
                    startNode.data('id',option);
                    startNode.removeData('children');

                    map.setStartAngle(120);

                    map.removeChildren(startNode);
    
                    map.onChildrenSet = function() {
                        map.setStartAngle(false);
                        var childNode = startNode.find('.' + option + 's-box').closest('.lb-network-node').last();

                        map.selectNode(childNode);
                        map.centerToNode(childNode);

                        map.onChildrenSet = function() { };
                    }

                    map.getChildren(startNode);
                } else {
                    $wheel.removeClass('director-selected decade-selected genre-selected');
                    map.removeChildren(startNode);
                    map.centerToNode(startNode);
                }
            });

            $('#network').on('mousedown', 'button.return-parent', function(e) {
                e.preventDefault();

                var map = $('#network').data('lbNetworkGraph');
                var currentNode = map.currentNode();
                
                map.selectNode(currentNode.data('parent'));
                map.centerToNode(currentNode.data('parent'));
                
            });

            $('#network').on('mouseenter', '.thumbnail', function() {
                $('#network').data('lbNetworkGraph').dragged = false;
            });

            $('#network').on('mousedown', '.thumbnail', function() {
                var $node = $(this).closest('.lb-network-node');
                var isSel = $(this).parent().parent().hasClass('collab-selected');
                var isTrail = $(this).parent().parent().hasClass('lb-trailing-node');
                
                if( !isSel && isTrail ) {
                    var map = $('#network').data('lbNetworkGraph');
                    map.removeChildren($node);
                }
            });
            
            $('.collab-fit').click(function(e) {
            	e.preventDefault();

            	var $this = $(this);
            	
            	if( !$this.hasClass('selected') ) {
            		$this.addClass('selected');
            		$this.siblings('a.selected').removeClass('selected');

		            var map = $('#network').data('lbNetworkGraph');
		            var startNode = map.getStartNode();
		            var offset = startNode.offset();
		            var minH = offset.left,
		            	maxH = offset.left,
		            	minV = offset.top,
		            	maxV = offset.top;
	
		            var $nodes = startNode.find('.lb-node');
		            
		            $nodes.each(function() {
			            var nOffset = $(this).offset();
	
			            minH = Math.min(minH, nOffset.left);
			            maxH = Math.max(maxH, nOffset.left);
			            minV = Math.min(minV, nOffset.top);
			            maxV = Math.max(maxV, nOffset.top);
		            });
		            
		            var tWidth	= maxH - minH;
		            var tHeight = maxV - minV;
		            
		            tWidth  += 500; // padding
		            tHeight += 500; // padding
	
		            var hArea = $('#network').width();
		            var vArea = $('#network').height();
		            
		            var vRatio = hArea/tHeight,
		            	hRatio = vArea/tWidth,
		            	ratio  = Math.min(vRatio, hRatio);
	
		            // grab the final coordinates of where we should end up
		            // with a centered fit
		            var centerX = ( ( map.map.position().left - minH - (tWidth/2)  ) * ratio ) + map.$el.width()/2,
		            	centerY = ( ( map.map.position().top  - minV - (tHeight/2) ) * ratio ) + map.$el.height()/2;
	
		            // scale to fit
	                var coords = map.map.offset(),
	                	xCoords = centerX-coords.left,
	                	yCoords = centerY-coords.top;
	
					map.map.data({ 'oldCoords' : coords, 'ratio' : ratio })
						   .transition({ x : xCoords, y : yCoords, scale : ratio*map.scaleSize(), duration : 400,
								complete: function() { 
	
									$(this).css({ left : centerX, top : centerY, x : 0, y : 0 });
								}
							});
				}
            });

            $('.collab-fit-back').click(function(e) {
            	e.preventDefault();

            	var $this = $(this);
            	
            	if( !$this.hasClass('selected') ) {
            		$this.addClass('selected');
            		$this.siblings('a.selected').removeClass('selected');

		            var map = $('#network').data('lbNetworkGraph');
		            var $current = map.currentNode();
	
		            var ratio = 1/map.map.css('scale');
	
		            // scale to fit
	                var coords = map.map.offset(),
	                	xCoords = map.map.data('oldCoords').left - coords.left,
	                	yCoords = map.map.data('oldCoords').top - coords.top;
	
					map.map.transition({ x : xCoords, y : yCoords, scale : 1, duration : 400,
								complete: function() { 
	
									$(this).css({ left : map.map.data('oldCoords').left, top : map.map.data('oldCoords').top, x : 0, y : 0 });
	
								}
							});
				}
            });

            $('#network').on('mousedown', 'button.change-relations', function(e) {
                var map = $('#network').data('lbNetworkGraph');
                var $button = $(this);
                var choice = $button.attr('rel');
                var currentNode = map.currentNode();

                currentNode.removeData('children').removeClass('collab-selected');;

                map.removeChildren(currentNode);

                if( $button.hasClass('set-decade') )
                    map.options.lineColour = '#8DC63F';
                else if( $button.hasClass('set-director') )
                    map.options.lineColour = '#ED1C24';
                else
                    map.options.lineColour = '#27AAE1';

                $.ajax({
                    url : './json-data/' + choice + '.json',
                    success : function(res) {
                        var children = res.children;
                        delete res.children;

                        currentNode.data('children', [res]);

                        map.onChildrenSet = function() {
                            map.onChildrenSet = function() { };

                            var childNode = currentNode.find('.children-nodes .lb-network-node').last();
                            childNode.data('children', children);

                            var childPar = childNode.parent();
                            childPar.removeClass('node-for-decade node-for-director node-for-genre');
                            childPar.addClass('node-for-' + childNode.data('type'));

                            map.onCenterNode = function() {
                                map.onCenterNode = function() {};

                                setTimeout(function() { map.getChildren(childNode) }, 1000);
                            }

                            map.selectNode(childNode);
                            map.centerToNode(childNode);
                        }

                        map.getChildren(currentNode);
                    }
                });
            });

            $('#network').on('mouseup', 'area', function(e) {
                var map = $('#network').data('lbNetworkGraph');
                setTimeout(function() { map.dragged = false; }, 10);
            });

            
            $('#network').on('mouseenter', '.group-node', function() {
                var map = $('#network').data('lbNetworkGraph');
                map.options.showChildren = true;
            }).on('mouseleave', '.group-node', function() {
                var map = $('#network').data('lbNetworkGraph');
                map.options.showChildren = false;
            });

            $('#network').on('click', '.option-list a', function(e) {
                e.preventDefault();

                var map = $('#network').data('lbNetworkGraph');
                var $select = $(this);
                var startNode = map.getStartNode();
                
                var $node = $select.closest('.lb-network-node');
                $node.data('line').remove();

                startNode.removeData('children');

                map.removeChildren(startNode);

                $.ajax({
                    url : './json-data/' + $select.attr('href') + '.json',
                    success : function(res) {
                        var children = res.children;
                        delete res.children;

                        startNode.data('children', [res]);
                        map.setStartAngle(80 + Math.floor(Math.random()*80));

                        map.onChildrenSet = function() {
                            map.onChildrenSet = function() { };
                            map.setStartAngle(false);

                            var childNode = startNode.find('.children-nodes .lb-network-node').last();
                            childNode.data('children', children);

                            var childPar = childNode.parent();
                            childPar.removeClass('node-for-decade node-for-director node-for-genre');
                            childPar.addClass('node-for-' + childNode.data('type'));

                            map.onCenterNode = function() {
                                map.onCenterNode = function() {};

                                setTimeout(function() { map.getChildren(childNode) }, 1000);
                            }

                            map.selectNode(childNode);
                            map.centerToNode(childNode);
                        }

                        map.getChildren(startNode);
                    }
                });
            });
        </script>
    </body>
</html>